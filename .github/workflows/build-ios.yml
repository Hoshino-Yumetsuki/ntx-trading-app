name: Build iOS IPA

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - ".gitignore"
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Enable Corepack
        run: corepack enable

      - name: Install Yarn
        run: corepack install yarn -g

      - name: Get Yarn cache directory
        id: yarn-cache-dir
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      - name: Cache Yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.yarn-cache-dir.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx', '**/*.css') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-
            ${{ runner.os }}-nextjs-

      - name: List available Xcode versions
        run: ls -la /Applications/ | grep Xcode

      - name: Select Xcode version
        run: |
          # 使用最新可用的 Xcode 版本
          XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          if [ -n "$XCODE_PATH" ]; then
            echo "Using Xcode: $XCODE_PATH"
            sudo xcode-select -s "$XCODE_PATH"
          fi
          xcodebuild -version

      - name: Install iOS SDK if needed
        run: |
          # 检查 iOS 平台是否已安装，如果没有则下载
          xcodebuild -downloadPlatform iOS || echo "iOS platform already installed or download not needed"

      - name: Install dependencies
        env:
          YARN_ENABLE_IMMUTABLE_INSTALLS: false
        run: yarn install

      - name: Install Capacitor iOS
        run: |
          yarn add @capacitor/ios@^8.0.0
          # 确保 capacitor cli 也安装了
          yarn add @capacitor/cli@^8.0.0

      - name: Build Next.js
        run: yarn build

      - name: Initialize Capacitor iOS
        run: |
          npx cap add ios
          echo "iOS platform added successfully"
          ls -la ios/App/

      - name: Get Build Timestamp
        id: timestamp
        run: echo "ts=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Get Package Version
        id: package
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Set App Version
        run: |
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ steps.timestamp.outputs.ts }}" ios/App/App/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.package.outputs.version }}" ios/App/App/Info.plist

      - name: Generate App Icons
        run: npx @capacitor/assets generate --ios

      - name: Sync Capacitor
        run: npx cap sync ios

      - name: List iOS project structure
        working-directory: ios/App
        run: |
          echo "=== Project files ==="
          ls -la
          echo "=== Checking for workspace ==="
          ls -la *.xcworkspace 2>/dev/null || echo "No workspace found"
          ls -la *.xcodeproj 2>/dev/null || echo "No xcodeproj found"

      - name: Build unsigned App
        working-directory: ios/App
        run: |
          # 先尝试用 workspace，如果没有再用 project
          if [ -d "App.xcworkspace" ]; then
            echo "Building with workspace..."
            xcodebuild -workspace App.xcworkspace \
              -scheme App \
              -configuration Release \
              -archivePath build/App.xcarchive \
              -destination 'generic/platform=iOS' \
              -allowProvisioningUpdates \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGN_IDENTITY="-" \
              DEVELOPMENT_TEAM="" \
              archive 2>&1 | tail -100
          else
            echo "Building with project..."
            xcodebuild -project App.xcodeproj \
              -scheme App \
              -configuration Release \
              -archivePath build/App.xcarchive \
              -destination 'generic/platform=iOS' \
              -allowProvisioningUpdates \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGN_IDENTITY="-" \
              DEVELOPMENT_TEAM="" \
              archive 2>&1 | tail -100
          fi
          
          echo "=== Archive contents ==="
          ls -la build/App.xcarchive/Products/Applications/ || echo "No Applications folder"

      - name: Create unsigned IPA
        working-directory: ios/App
        run: |
          mkdir -p build/Payload
          cp -r build/App.xcarchive/Products/Applications/App.app build/Payload/
          cd build
          zip -r NTX-unsigned.ipa Payload
          rm -rf Payload

      - name: Upload unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: NTX-iOS-unsigned
          path: ios/App/build/NTX-unsigned.ipa
          retention-days: 30
