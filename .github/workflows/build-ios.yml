name: Build iOS IPA

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - ".gitignore"
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Enable Corepack
        run: corepack enable

      - name: Install Yarn
        run: corepack install yarn -g

      - name: Get Yarn cache directory
        id: yarn-cache-dir
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      - name: Cache Yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.yarn-cache-dir.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx', '**/*.css') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-
            ${{ runner.os }}-nextjs-

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.4.app

      - name: Install dependencies
        env:
          YARN_ENABLE_IMMUTABLE_INSTALLS: false
        run: yarn install

      - name: Install Capacitor iOS
        run: yarn add @capacitor/ios

      - name: Build Next.js
        run: yarn build

      - name: Initialize Capacitor iOS
        env:
          CAPACITOR_IOS_POD_INSTALL: "0"
        run: npx cap add ios || true

      - name: Set iOS deployment target to 15
        run: |
          python3 - <<'PY'
          from pathlib import Path
          import re

          print("Updating Podfile...")
          podfile = Path('ios/App/Podfile')
          if podfile.exists():
            text = podfile.read_text()
            # Match platform :ios, 'x.x' with optional comment # at start
            pattern = r"(?:#\s*)?platform :ios,\s*['\"][\d\.]+['\"]"
            replacement = "platform :ios, '15.0'"
            
            if re.search(pattern, text):
                updated = re.sub(pattern, replacement, text)
                print("Replaced existing platform line.")
            else:
                updated = "platform :ios, '15.0'\n" + text
                print("Prepended platform line.")
            
            podfile.write_text(updated)
            print("Podfile updated.")
          else:
            print("Podfile not found!")

          print("Updating project.pbxproj...")
          pbxproj = Path('ios/App/App.xcodeproj/project.pbxproj')
          if pbxproj.exists():
            content = pbxproj.read_text()
            # Update IPHONEOS_DEPLOYMENT_TARGET
            content = re.sub(r"IPHONEOS_DEPLOYMENT_TARGET = [\d\.]+;", "IPHONEOS_DEPLOYMENT_TARGET = 15.0;", content)
            pbxproj.write_text(content)
            print("project.pbxproj updated.")
          else:
            print("project.pbxproj not found!")
          PY

      - name: Get Build Timestamp
        id: timestamp
        run: echo "ts=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Get Package Version
        id: package
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Set App Version
        run: |
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ steps.timestamp.outputs.ts }}" ios/App/App/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.package.outputs.version }}" ios/App/App/Info.plist

      - name: Generate App Icons
        run: npx @capacitor/assets generate --ios

      - name: Sync Capacitor
        env:
          CAPACITOR_IOS_POD_INSTALL: "0"
        run: npx cap sync ios

      - name: Install CocoaPods dependencies
        working-directory: ios/App
        run: pod install

      - name: Build unsigned App
        working-directory: ios/App
        run: |
          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath build/App.xcarchive \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            archive

      - name: Create unsigned IPA
        working-directory: ios/App
        run: |
          mkdir -p build/Payload
          cp -r build/App.xcarchive/Products/Applications/App.app build/Payload/
          cd build
          zip -r NTX-unsigned.ipa Payload
          rm -rf Payload

      - name: Upload unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: NTX-iOS-unsigned
          path: ios/App/build/NTX-unsigned.ipa
          retention-days: 30
